@page "/NewProduct"
@page "/NewProduct/{id:int}"

@attribute [Authorize(Policy = "AdminPolicy")]
@using Bakr.Client.Pages
@using Bakr.Data
@using Bakr.Endpoints
@using System.Text.Json
@using Bakr.Mapping
@using Bakr.Shared.Dtos
@using Bakr.Shared.Entities
@using Microsoft.AspNetCore.Http.HttpResults

@attribute [StreamRendering]
@inject ApplicationDbContext dbContext
@inject NavigationManager NavigationManager

<PageTitle>@title</PageTitle>

<EditProduct Id="@Id" genres="@genres" productFromParent="@product" title="@title"/>

<br/>

@code {
    [Parameter]
    public int? Id {get; set;}
    private List<Genre>? genres;
    private ProductDetails? product;

    private string? title;

    protected override void OnParametersSet()
    {
        if (Id is null)
        {
            product = new()
            {
                Name = string.Empty,
                Price = 0
            };
            title = "New Product";
        }
    }


    protected override async Task OnInitializedAsync() 
    {
        genres = await GenresEndpoint.GetGenresAsync(dbContext) switch 
        {
            Ok<List<Genre>> ok => ok.Value,
            _ => []
        };
        
        if(Id is not null) {
            var result = await ProductsEndpoint.GetProductAsync(Id.Value, dbContext);
            switch (result.Result) {
                case Ok<ProductDto> ok:
                    product = ok.Value!.ToDetails();
                    title = $"Edit {product.Name}";
                    break;
                case Microsoft.AspNetCore.Http.HttpResults.NotFound notFound:
                    NavigationManager.NavigateTo("/NotFound");
                    break;
                default:
                    NavigationManager.NavigateTo("/Error");
                    break;
            }
        }
    }
}
